name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  COVERAGE_THRESHOLD: 70

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build
        run: go build ./...
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache tools
        uses: actions/cache@v4
        with:
          path: bin
          key: tools-${{ runner.os }}-${{ hashFiles('tools/tools.go') }}
          restore-keys: |
            tools-${{ runner.os }}-

      - name: Run lint
        run: make lint
        env:
          LOCAL_BIN: ${{ github.workspace }}/bin
  
  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: root
          POSTGRES_PASSWORD: password
          POSTGRES_DB: pvz-service_db
        ports:
          - 5439:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Go
          uses: actions/setup-go@v5
          with:
            go-version-file: go.mod
            cache: true

        - name: Run tests
          run: make test
          env:
            DB_HOST: localhost
            DB_PORT: 5439
            DB_USER: root
            DB_PASSWORD: password
            DB_NAME: pvz-service_db

        - name: Upload coverage artifact
          if: always() && hashFiles('coverage.out') != ''
          uses: actions/upload-artifact@v4
          continue-on-error: true
          with:
            name: coverage-report
            path: coverage.out
            retention-days: 7

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report

      - name: Coverage report
        if: hashFiles('coverage.out') != ''
        run: make coverage-ci

      - name: Check coverage threshold
        if: hashFiles('coverage.out') != ''
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: $COVERAGE%"
          if awk "BEGIN {exit !($COVERAGE < ${{ env.COVERAGE_THRESHOLD }})}"; then
            echo "❌ Coverage $COVERAGE% is below threshold ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% passed"

      - name: Upload coverage to Codecov
        if: hashFiles('coverage.out') != ''
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: coverage.out
          fail_ci_if_error: false